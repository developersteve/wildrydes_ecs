{"version":3,"file":"HttpInstrumentation.js","sourceRoot":"","sources":["../../../../src/instrumentations/https/HttpInstrumentation.ts"],"names":[],"mappings":";;AACA,8EAA0E;AAE1E,iCAAmC;AACnC,kDAA+C;AAE/C,MAAqB,yBAA0B,SAAQ,2BAAiC;IAGtF,YAAY,GAAG,gBAA0B;QACvC,KAAK,EAAE,CAAC;QAeV,0BAAqB,GAAG,GAAG,EAAE,CAAC,MAAM,CAAC;QAErC,uBAAkB,GAAG,GAAG,EAAE,CACxB,IAAI,0CAAmB,CAAC;YACtB,yBAAyB,EAAE,CAAC,OAAuB,EAAE,EAAE;gBACrD;;;mBAGG;gBACH,MAAM,eAAe,GAAG,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,IAAI,CAAC;gBACzD,MAAM,gBAAgB,GACpB,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,eAAe,CAAC;oBAC/C,+EAA+E;oBAC/E,wBAAwB,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;gBAEjD,OAAO,gBAAgB,CAAC;YAC1B,CAAC;YACD,WAAW,EAAE,gBAAS,CAAC,WAAW;YAClC,YAAY,EAAE,gBAAS,CAAC,YAAY;SACrC,CAAC,CAAC;QAhCH,IAAI,CAAC,gBAAgB,GAAG,CAAC,gBAAgB,IAAI,EAAE,CAAC,CAAC,MAAM,CACrD,CAAC,OAAO,CAAC,GAAG,CAAC,0BAA0B,EAAE,OAAO,CAAC,GAAG,CAAC,6BAA6B,CAAC;aAChF,MAAM,CAAC,OAAO,CAAC;aACf,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE;YACX,IAAI;gBACF,OAAO,IAAI,GAAG,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC;aAC9B;YAAC,OAAO,GAAG,EAAE;gBACZ,OAAO;aACR;QACH,CAAC,CAAC,CACL,CAAC;IACJ,CAAC;CAsBF;AAvCD,4CAuCC","sourcesContent":["import { RequestOptions } from 'https';\nimport { HttpInstrumentation } from '@opentelemetry/instrumentation-http';\n\nimport { HttpHooks } from './http';\nimport { Instrumentor } from '../instrumentor';\n\nexport default class LumigoHttpInstrumentation extends Instrumentor<HttpInstrumentation> {\n  private readonly ignoredHostnames: string[];\n\n  constructor(...ignoredHostnames: string[]) {\n    super();\n\n    this.ignoredHostnames = (ignoredHostnames || []).concat(\n      [process.env.ECS_CONTAINER_METADATA_URI, process.env.ECS_CONTAINER_METADATA_URI_V4]\n        .filter(Boolean)\n        .map((url) => {\n          try {\n            return new URL(url).hostname;\n          } catch (err) {\n            return;\n          }\n        })\n    );\n  }\n\n  getInstrumentedModule = () => 'http';\n\n  getInstrumentation = () =>\n    new HttpInstrumentation({\n      ignoreOutgoingRequestHook: (request: RequestOptions) => {\n        /*\n         * Some requests, like towards the ECS Credentials endpoints, do not have the\n         * hostname set, but they do have the host\n         */\n        const requestHostname = request.hostname || request.host;\n        const isRequestIgnored =\n          this.ignoredHostnames.includes(requestHostname) ||\n          // Unroutable addresses, used by metadata and credential services on all clouds\n          /169\\.254\\.\\d+\\.\\d+.*/gm.test(requestHostname);\n\n        return isRequestIgnored;\n      },\n      requestHook: HttpHooks.requestHook,\n      responseHook: HttpHooks.responseHook,\n    });\n}\n"]}